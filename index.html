<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>12ì›” ì¼ì • íˆ¬í‘œ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: 12px;
    }

    .container {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 6px;
      font-size: 1.4rem;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 16px;
      font-size: 0.8rem;
    }

    .select-section {
      margin-bottom: 16px;
    }

    .select-section label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #444;
      font-size: 0.9rem;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px; /* iOS zoom ë°©ì§€ */
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px 12px;
      margin-bottom: 16px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .calendar {
      margin-bottom: 16px;
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: 6px;
    }

    .calendar-header span {
      text-align: center;
      font-weight: 600;
      color: #666;
      font-size: 0.75rem;
      padding: 6px 0;
    }

    .calendar-header span:first-child {
      color: #e74c3c;
    }

    .calendar-header span:last-child {
      color: #3498db;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }

    .day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      background: white;
      min-height: 40px;
      -webkit-tap-highlight-color: transparent;
    }

    .day:active:not(.empty):not(.past) {
      transform: scale(0.95);
    }

    .day.empty {
      border: none;
      cursor: default;
    }

    .day.past {
      background: #f5f5f5;
      color: #bbb;
      cursor: not-allowed;
    }

    .day.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .day-number {
      font-weight: 600;
      font-size: 0.85rem;
      line-height: 1;
    }

    .day:nth-child(7n+1) .day-number {
      color: #e74c3c;
    }

    .day:nth-child(7n) .day-number {
      color: #3498db;
    }

    .day.selected .day-number {
      color: white;
    }

    .day.past .day-number {
      color: #bbb !important;
    }

    .votes-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-top: 2px;
      justify-content: center;
      max-width: 100%;
    }

    .vote-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .btn-container {
      display: flex;
      gap: 10px;
    }

    .btn {
      flex: 1;
      padding: 14px 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }

    .btn-secondary:active {
      background: #e0e0e0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      text-align: center;
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
    }

    /* ì‘ì€ í™”ë©´ (iPhone SE ë“±) */
    @media (max-width: 360px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 14px;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.2rem;
      }

      .legend {
        gap: 6px 10px;
        padding: 8px;
      }

      .legend-item {
        font-size: 0.7rem;
      }

      .legend-dot {
        width: 8px;
        height: 8px;
      }

      .calendar-grid {
        gap: 2px;
      }

      .day {
        border-radius: 6px;
        border-width: 1.5px;
        min-height: 36px;
      }

      .day-number {
        font-size: 0.75rem;
      }

      .vote-dot {
        width: 5px;
        height: 5px;
      }

      .btn {
        padding: 12px 8px;
        font-size: 0.9rem;
      }
    }

    /* ì¤‘ê°„ í™”ë©´ */
    @media (min-width: 361px) and (max-width: 480px) {
      .day {
        min-height: 44px;
      }
    }

    /* í° í™”ë©´ (íƒœë¸”ë¦¿/ë°ìŠ¤í¬íƒ‘) */
    @media (min-width: 481px) {
      body {
        padding: 20px;
      }

      .container {
        padding: 30px;
        border-radius: 20px;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 0.9rem;
        margin-bottom: 25px;
      }

      .legend {
        gap: 12px 16px;
        padding: 15px;
      }

      .legend-item {
        font-size: 0.85rem;
      }

      .legend-dot {
        width: 12px;
        height: 12px;
      }

      .calendar-grid {
        gap: 5px;
      }

      .day {
        min-height: 50px;
        border-radius: 10px;
      }

      .day:hover:not(.empty):not(.past) {
        border-color: #667eea;
        transform: scale(1.05);
      }

      .day-number {
        font-size: 0.95rem;
      }

      .vote-dot {
        width: 8px;
        height: 8px;
      }

      .btn {
        padding: 15px;
        font-size: 1rem;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }
    }

    /* ì•ˆì „ ì˜ì—­ (ë…¸ì¹˜ ëŒ€ì‘) */
    @supports (padding: env(safe-area-inset-bottom)) {
      body {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        padding-left: calc(12px + env(safe-area-inset-left));
        padding-right: calc(12px + env(safe-area-inset-right));
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“… 12ì›” ì¼ì • íˆ¬í‘œ</h1>
    <p class="subtitle">2025ë…„ 12ì›” - ê°€ëŠ¥í•œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>

    <div class="select-section">
      <label for="personSelect">ğŸ‘¤ ì´ë¦„ ì„ íƒ</label>
      <select id="personSelect">
        <option value="">-- ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="ê³ ê±´ìš°">ê³ ê±´ìš°</option>
        <option value="ê¹€ë™í¬">ê¹€ë™í¬</option>
        <option value="ê¹€ì§€ìˆ˜">ê¹€ì§€ìˆ˜</option>
        <option value="ì•ˆì ¤ë¼">ì•ˆì ¤ë¼</option>
        <option value="ìœ ì„í™˜">ìœ ì„í™˜</option>
        <option value="ì¡°ì—°ìˆ˜">ì¡°ì—°ìˆ˜</option>
      </select>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background: #e74c3c;"></div>
        <span>ê³ ê±´ìš°</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #3498db;"></div>
        <span>ê¹€ë™í¬</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #2ecc71;"></div>
        <span>ê¹€ì§€ìˆ˜</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #f39c12;"></div>
        <span>ì•ˆì ¤ë¼</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #9b59b6;"></div>
        <span>ìœ ì„í™˜</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #F6B1CE;"></div>
        <span>ì¡°ì—°ìˆ˜</span>
      </div>
    </div>

    <div class="calendar">
      <div class="calendar-header">
        <span>ì¼</span>
        <span>ì›”</span>
        <span>í™”</span>
        <span>ìˆ˜</span>
        <span>ëª©</span>
        <span>ê¸ˆ</span>
        <span>í† </span>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="btn-container">
      <button class="btn btn-secondary" id="resetBtn">ì´ˆê¸°í™”</button>
      <button class="btn btn-primary" id="saveBtn" disabled>ì €ì¥í•˜ê¸°</button>
    </div>

    <div class="status" id="status" style="display: none;"></div>
  </div>

  <script>
    // ============================================
    // Supabase ì„¤ì •
    // ============================================
    const SUPABASE_URL = 'https://xxtebninrfqaptushbvl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4dGVibmlucmZxYXB0dXNoYnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NjA3MTMsImV4cCI6MjA4MDMzNjcxM30.31O2XSAknqlSWjkTOG4cxVnJ4K9MXS8GGDgIMjzfqdo';
    // ============================================

    // ì‚¬ëŒë³„ ìƒ‰ìƒ
    const COLORS = {
      'ê³ ê±´ìš°': '#e74c3c',
      'ê¹€ë™í¬': '#3498db',
      'ê¹€ì§€ìˆ˜': '#2ecc71',
      'ì•ˆì ¤ë¼': '#f39c12',
      'ìœ ì„í™˜': '#9b59b6',
      'ì¡°ì—°ìˆ˜': '#F6B1CE'
    };

    // ìƒíƒœ
    let supabase = null;
    let selectedDates = [];
    let allVotes = {};
    let currentPerson = '';

    // DOM ìš”ì†Œ
    const personSelect = document.getElementById('personSelect');
    const calendarGrid = document.getElementById('calendarGrid');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const status = document.getElementById('status');

    // ì´ˆê¸°í™”
    function init() {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      loadAllVotes();
      renderCalendar();
      
      personSelect.addEventListener('change', onPersonChange);
      saveBtn.addEventListener('click', saveVotes);
      resetBtn.addEventListener('click', resetSelection);
    }

    // ë‹¬ë ¥ ë Œë”ë§
    function renderCalendar() {
      calendarGrid.innerHTML = '';
      
      // 2025ë…„ 12ì›” 1ì¼ì€ ì›”ìš”ì¼ (ì‹œì‘ ìš”ì¼: 1)
      const firstDay = 1; // 0=ì¼, 1=ì›”, ...
      const daysInMonth = 31;
      const today = new Date();
      const currentDay = today.getFullYear() === 2025 && today.getMonth() === 11 ? today.getDate() : 0;

      // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'day empty';
        calendarGrid.appendChild(emptyDay);
      }

      // ë‚ ì§œ ì±„ìš°ê¸°
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'day';
        dayEl.dataset.day = day;

        if (day < currentDay) {
          dayEl.classList.add('past');
        }

        // ë‚ ì§œ ìˆ«ì
        const dayNumber = document.createElement('span');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayEl.appendChild(dayNumber);

        // íˆ¬í‘œ í‘œì‹œ ì»¨í…Œì´ë„ˆ
        const votesContainer = document.createElement('div');
        votesContainer.className = 'votes-container';
        dayEl.appendChild(votesContainer);

        // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
        if (selectedDates.includes(day)) {
          dayEl.classList.add('selected');
        }

        // í´ë¦­ ì´ë²¤íŠ¸
        if (day >= currentDay && currentPerson) {
          dayEl.addEventListener('click', () => toggleDate(day));
        }

        calendarGrid.appendChild(dayEl);
      }

      updateVoteDots();
    }

    // íˆ¬í‘œ ì  ì—…ë°ì´íŠ¸
    function updateVoteDots() {
      document.querySelectorAll('.day:not(.empty)').forEach(dayEl => {
        const day = parseInt(dayEl.dataset.day);
        const votesContainer = dayEl.querySelector('.votes-container');
        votesContainer.innerHTML = '';

        Object.entries(allVotes).forEach(([person, dates]) => {
          if (dates.includes(day) && person !== currentPerson) {
            const dot = document.createElement('div');
            dot.className = 'vote-dot';
            dot.style.background = COLORS[person];
            dot.title = person;
            votesContainer.appendChild(dot);
          }
        });
      });
    }

    // ë‚ ì§œ í† ê¸€
    function toggleDate(day) {
      if (!currentPerson) return;

      const index = selectedDates.indexOf(day);
      if (index > -1) {
        selectedDates.splice(index, 1);
      } else {
        selectedDates.push(day);
      }
      selectedDates.sort((a, b) => a - b);
      
      renderCalendar();
      saveBtn.disabled = false;
    }

    // ì‚¬ëŒ ë³€ê²½
    async function onPersonChange() {
      currentPerson = personSelect.value;
      selectedDates = [];
      
      if (currentPerson && supabase) {
        showStatus('loading', 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        try {
          const { data, error } = await supabase
            .from('votes')
            .select('selected_dates')
            .eq('person_name', currentPerson)
            .single();

          if (error) throw error;
          
          selectedDates = data?.selected_dates || [];
          showStatus('success', `${currentPerson}ë‹˜ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
          setTimeout(() => hideStatus(), 2000);
        } catch (err) {
          console.error(err);
          showStatus('error', 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
      }

      saveBtn.disabled = !currentPerson;
      renderCalendar();
    }

    // ëª¨ë“  íˆ¬í‘œ ë¡œë“œ
    async function loadAllVotes() {
      if (!supabase) return;

      try {
        const { data, error } = await supabase
          .from('votes')
          .select('person_name, selected_dates');

        if (error) throw error;

        allVotes = {};
        data.forEach(row => {
          allVotes[row.person_name] = row.selected_dates || [];
        });

        updateVoteDots();
      } catch (err) {
        console.error('íˆ¬í‘œ ë¡œë“œ ì‹¤íŒ¨:', err);
      }
    }

    // ì €ì¥
    async function saveVotes() {
      if (!currentPerson || !supabase) return;

      showStatus('loading', 'ì €ì¥ ì¤‘...');
      saveBtn.disabled = true;

      try {
        const { error } = await supabase
          .from('votes')
          .update({ 
            selected_dates: selectedDates,
            updated_at: new Date().toISOString()
          })
          .eq('person_name', currentPerson);

        if (error) throw error;

        allVotes[currentPerson] = [...selectedDates];
        showStatus('success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ“');
        updateVoteDots();
        
        setTimeout(() => hideStatus(), 2000);
      } catch (err) {
        console.error(err);
        showStatus('error', 'ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }

      saveBtn.disabled = false;
    }

    // ì´ˆê¸°í™”
    function resetSelection() {
      selectedDates = [];
      renderCalendar();
      if (currentPerson) {
        saveBtn.disabled = false;
      }
    }

    // ìƒíƒœ í‘œì‹œ
    function showStatus(type, message) {
      status.className = 'status ' + type;
      status.textContent = message;
      status.style.display = 'block';
    }

    function hideStatus() {
      status.style.display = 'none';
    }

    // ì‹œì‘
    init();
  </script>
</body>
</html>
